"""
SCRIPT AUTOM√ÅTICO COMPLETO
DICOM ‚Üí Extrai PDF ‚Üí Converte para PNG ‚Üí Anonimiza ‚Üí Salva

Coloque seus DICOMs em pasta_com_dicoms/ e execute!
"""

import os
import pydicom
from PIL import Image, ImageDraw, ImageFont
import io

input_folder = "pasta_com_dicoms"
output_folder = "ecgs_anonimizados"

os.makedirs(output_folder, exist_ok=True)

def anonimizar_metadados(ds, contador):
    """Anonimiza metadados do DICOM"""
    campos_anonimos = [
        "PatientID", "PatientName", "PatientSex", "PatientBirthDate", "PatientAge",
        "EthnicGroup", "ReferringPhysicianName", "InstitutionName", "InstitutionAddress",
        "StudyDate", "SeriesDate", "AcquisitionDate", "ContentDate",
        "PatientAddress", "PatientTelephoneNumbers", "AccessionNumber", "StudyID"
    ]
    
    for campo in campos_anonimos:
        if campo in ds:
            elemento = ds.data_element(campo)
            if elemento is not None:
                if elemento.VR == 'DA':
                    elemento.value = "20000101"
                elif elemento.VR == 'TM':
                    elemento.value = "000000"
                else:
                    elemento.value = "ANONIMIZADO"
    
    ds.PatientID = f"ANON_{contador:04d}"
    ds.PatientName = f"ANONIMIZADO_{contador:04d}"
    
    return ds

def converter_pdf_para_imagem_PIL(pdf_data):
    """
    Converte PDF para imagem usando PIL + pdf2image
    """
    try:
        from pdf2image import convert_from_bytes
        images = convert_from_bytes(pdf_data, dpi=200)
        if images:
            return images[0]
        return None
    except Exception as e:
        print(f"    ‚ö†Ô∏è  pdf2image falhou: {e}")
        return None

def converter_pdf_para_imagem_PyMuPDF(pdf_data):
    """
    Converte PDF para imagem usando PyMuPDF (fitz) - N√ÉO PRECISA POPPLER!
    """
    try:
        import fitz  # PyMuPDF
        
        # Abre PDF dos bytes
        doc = fitz.open(stream=pdf_data, filetype="pdf")
        
        # Pega primeira p√°gina
        page = doc[0]
        
        # Converte para imagem (matriz de pixels)
        # zoom=2 para boa qualidade
        mat = fitz.Matrix(2, 2)
        pix = page.get_pixmap(matrix=mat)
        
        # Converte para PIL Image
        img_data = pix.tobytes("png")
        img = Image.open(io.BytesIO(img_data))
        
        doc.close()
        
        return img
        
    except ImportError:
        print(f"    ‚ö†Ô∏è  PyMuPDF n√£o instalado")
        return None
    except Exception as e:
        print(f"    ‚ö†Ô∏è  PyMuPDF falhou: {e}")
        return None

def anonimizar_imagem(img, largura_percentual=0.30, altura_percentual=0.29):
    """Oculta regi√£o superior esquerda com dados sens√≠veis"""
    
    if img.mode != 'RGB':
        img = img.convert('RGB')
    
    largura_ocultar = int(img.size[0] * largura_percentual)
    altura_ocultar = int(img.size[1] * altura_percentual)
    
    draw = ImageDraw.Draw(img)
    draw.rectangle([(0, 0), (largura_ocultar, altura_ocultar)], fill='black')
    
    # Texto de anonimiza√ß√£o
    try:
        tamanho_fonte = max(20, int(altura_ocultar * 0.08))
        try:
            font_titulo = ImageFont.truetype("arial.ttf", tamanho_fonte)
            font_sub = ImageFont.truetype("arial.ttf", int(tamanho_fonte * 0.6))
        except:
            font_titulo = ImageFont.load_default()
            font_sub = ImageFont.load_default()
    except:
        font_titulo = ImageFont.load_default()
        font_sub = ImageFont.load_default()
    
    margem = 10
    y = margem
    
    if font_titulo:
        draw.text((margem, y), "DADOS ANONIMIZADOS", fill='white', font=font_titulo)
        y += tamanho_fonte + 5
        draw.text((margem, y), "Conforme LGPD", fill='lightgray', font=font_sub)
        y += int(tamanho_fonte * 0.6) + 10
        
        infos = ["‚Ä¢ ID Paciente", "‚Ä¢ Nome", "‚Ä¢ Dados Cl√≠nicos"]
        for info in infos:
            draw.text((margem, y), info, fill='darkgray', font=font_sub)
            y += int(tamanho_fonte * 0.5) + 2
    else:
        draw.text((margem, y), "DADOS ANONIMIZADOS - LGPD", fill='white')
    
    return img, largura_ocultar, altura_ocultar

# ============================================================================
# PROCESSAMENTO PRINCIPAL
# ============================================================================

print("="*80)
print("ANONIMIZADOR AUTOM√ÅTICO DE ECGs - HUSM")
print("DICOM ‚Üí PDF ‚Üí PNG ‚Üí Anonimizado")
print("="*80)
print(f"\nüìÅ Pasta entrada: {input_folder}")
print(f"üìÅ Pasta sa√≠da: {output_folder}\n")

# Verifica se PyMuPDF est√° instalado
try:
    import fitz
    print("‚úì PyMuPDF instalado - Convers√£o autom√°tica habilitada!\n")
    usar_pymupdf = True
except ImportError:
    print("‚ö†Ô∏è  PyMuPDF n√£o instalado")
    print("   Instalando automaticamente...\n")
    import subprocess
    import sys
    try:
        subprocess.check_call([sys.executable, "-m", "pip", "install", "PyMuPDF"])
        print("‚úì PyMuPDF instalado com sucesso!\n")
        import fitz
        usar_pymupdf = True
    except:
        print("‚ùå Falha ao instalar PyMuPDF")
        print("   Tentar√° usar pdf2image (requer Poppler)\n")
        usar_pymupdf = False

contador = 0
sucesso = 0
falhas = 0

# ============================================================================
# BUSCA RECURSIVA - Encontra todos os DICOMs em subpastas
# ============================================================================
print("üîç Buscando arquivos DICOM (incluindo subpastas)...\n")

arquivos_dicom = []
for root, dirs, files in os.walk(input_folder):
    for filename in files:
        if filename.lower().endswith('.dcm'):
            caminho_completo = os.path.join(root, filename)
            # Calcula caminho relativo para exibir
            caminho_relativo = os.path.relpath(caminho_completo, input_folder)
            arquivos_dicom.append({
                'caminho_completo': caminho_completo,
                'caminho_relativo': caminho_relativo,
                'nome_paciente': os.path.basename(root),  # Nome da pasta do paciente
                'filename': filename
            })

if not arquivos_dicom:
    print(f"‚ùå Nenhum arquivo DICOM encontrado em '{input_folder}/' (incluindo subpastas)")
    print(f"\nüí° Estrutura esperada:")
    print(f"   {input_folder}/")
    print(f"   ‚îú‚îÄ‚îÄ paciente_001/")
    print(f"   ‚îÇ   ‚îî‚îÄ‚îÄ ecg.dcm")
    print(f"   ‚îú‚îÄ‚îÄ paciente_002/")
    print(f"   ‚îÇ   ‚îî‚îÄ‚îÄ ecg.dcm")
    print(f"   ‚îî‚îÄ‚îÄ ...")
    print(f"\n   Coloque o ZIP extra√≠do na pasta '{input_folder}/' e execute novamente!")
    exit(1)

print(f"‚úÖ Encontrados {len(arquivos_dicom)} arquivo(s) DICOM em subpastas!\n")

# Mostra preview das pastas encontradas
pastas_unicas = set(info['nome_paciente'] for info in arquivos_dicom)
print(f"üìÇ Pastas de pacientes encontradas: {len(pastas_unicas)}")
for i, pasta in enumerate(sorted(pastas_unicas)[:5], 1):
    print(f"   {i}. {pasta}")
if len(pastas_unicas) > 5:
    print(f"   ... e mais {len(pastas_unicas) - 5} pastas")
print()

for info in arquivos_dicom:
    contador += 1
    print(f"{'='*80}")
    print(f"[{contador}/{len(arquivos_dicom)}] {info['caminho_relativo']}")
    print(f"{'='*80}")
    
    caminho_arquivo = info['caminho_completo']
    filename = info['filename']
    
    try:
        # 1. L√ä DICOM
        print(f"  üìñ Lendo DICOM...")
        ds = pydicom.dcmread(caminho_arquivo)
        print(f"     ‚úì ID: {ds.get('PatientID', 'N/A')}")
        print(f"     ‚úì Nome: {ds.get('PatientName', 'N/A')}")
        
        # 2. ANONIMIZA METADADOS (apenas para ter ID √∫nico)
        print(f"\n  üîí Gerando ID anonimizado...")
        ds = anonimizar_metadados(ds, contador)
        print(f"     ‚úì Novo ID: {ds.PatientID}")
        
        # 3. EXTRAI PDF
        print(f"\n  üìÑ Extraindo PDF embutido...")
        if not hasattr(ds, 'EncapsulatedDocument'):
            print(f"     ‚ùå Este DICOM n√£o tem PDF embutido")
            falhas += 1
            continue
        
        pdf_data = ds.EncapsulatedDocument
        print(f"     ‚úì PDF extra√≠do ({len(pdf_data):,} bytes)")
        
        # 4. CONVERTE PDF PARA IMAGEM
        print(f"\n  üñºÔ∏è  Convertendo PDF para PNG...")
        
        img = None
        
        # Tenta PyMuPDF primeiro (n√£o precisa Poppler!)
        if usar_pymupdf:
            img = converter_pdf_para_imagem_PyMuPDF(pdf_data)
            if img:
                print(f"     ‚úì Convertido com PyMuPDF")
        
        # Se falhou, tenta pdf2image
        if img is None:
            img = converter_pdf_para_imagem_PIL(pdf_data)
            if img:
                print(f"     ‚úì Convertido com pdf2image")
        
        if img is None:
            print(f"     ‚ùå Falha na convers√£o")
            print(f"     üí° Instale: pip install PyMuPDF")
            falhas += 1
            continue
        
        print(f"     ‚úì Imagem: {img.size[0]} x {img.size[1]} pixels")
        
        # 5. ANONIMIZA IMAGEM
        print(f"\n  üîê Anonimizando regi√£o com dados sens√≠veis...")
        img_anon, larg_oc, alt_oc = anonimizar_imagem(img)
        print(f"     ‚úì Regi√£o ocultada: {larg_oc} x {alt_oc} px")
        print(f"     ‚úì Percentual: 20% largura x 25% altura")
        
        # 6. SALVA PNG ANONIMIZADO
        nome_png = f"anonimizado_{contador:04d}.png"
        caminho_png = os.path.join(output_folder, nome_png)
        img_anon.save(caminho_png, quality=95, optimize=True)
        
        print(f"\n  ‚úÖ PNG ANONIMIZADO SALVO: {nome_png}")
        print(f"     üìä Tamanho: {os.path.getsize(caminho_png):,} bytes")
        
        sucesso += 1
        
    except Exception as e:
        print(f"\n  ‚ùå ERRO: {e}")
        import traceback
        traceback.print_exc()
        falhas += 1
    
    print()

# RESUMO FINAL
print("="*80)
print("PROCESSAMENTO CONCLU√çDO!")
print("="*80)
print(f"\nüìä ESTAT√çSTICAS:")
print(f"   Total de arquivos: {contador}")
print(f"   ‚úÖ Sucesso: {sucesso}")
print(f"   ‚ùå Falhas: {falhas}")

if sucesso > 0:
    print(f"\n‚ú® RESULTADO:")
    print(f"   üìÅ {sucesso} arquivo(s) anonimizado(s) com sucesso!")
    print(f"   üìÇ Localiza√ß√£o: {os.path.abspath(output_folder)}/")
    print(f"\n   Arquivos gerados:")
    print(f"   ‚Ä¢ anonimizado_XXXX.png - Imagens PNG anonimizadas (prontas para uso)")

if falhas > 0:
    print(f"\n‚ö†Ô∏è  ATEN√á√ÉO: {falhas} arquivo(s) com falha")
    print(f"   Verifique os logs acima para detalhes")

print(f"\n{'='*80}")
print("Dataset pronto para uso no TCC! üéì")
print("="*80)
